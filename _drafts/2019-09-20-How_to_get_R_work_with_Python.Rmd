---
title: "How to get R work with Python"
subtitle: "A practical example of how to use R code in Python"
author: "Jens Laufer"
date: "20 9 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message = F, warning = F)
```


R and Python are outstanding languages for data science. While Python is a easy-to-learn general-purpose language R 
is a niche language from the statistics fields. Python's pandas and numpy library  and base R are very similiar for 
data processing. One could say, that there is no need to learn R, however thanks to Hadley Wickham's tidyverse 
libraries with their grammar of graphics (ggplot2) and grammar of data manipulation (dpylr) 
R is superior for data analysis and processing. It's therefore worth to have both languages in your toolset. 

Is it possible to use the language site-by-site? Let's think of a scenario where we use R for 
data preprocessing and Python for training machine learning models. In this article I want to show you 
how to use R functions in our Python code. We want to use [rpy2](https://rpy2.readthedocs.io), which lets us 
call functions in R library like functions in Python code. However there are several pitfalls I want to show you. 
We use Docker in this example to get reprocable environment.


## 1. A R library living in Github ##

Our library just have one function to get the things easy and self explaining. The function receives a time series dataframe and reduces it to
a certain period unit. E.g. you pump a dataframe in with a by second timestep you can reduce it to a dataframe on a 1 minute period. 
For all quantitive variables the function takes the mean. 

If you have never wrote a R libary this is a quick introduction. You can skip this part, in case you have written python libraries before.

### Setup of the library boilerplate code ###

We change into a R console

```R
install.packages('devtools')
library('devtools')
devtools::create('reducer')
```

These commands create a basic file structure for our module. The R directory will hold all R files for our library.

```shell
.
├── DESCRIPTION
├── NAMESPACE
└── R
```
NAMESPACE

```R
exportPattern("^[^\\.]")
importFrom("magrittr","%>%")
```

DESCRIPTION
```yaml
Package: reducer
Title: Reduces time series
Version: 0.1.0
Authors@R: 
    person(given = "First",
           family = "Last",
           role = c("aut", "cre"),
           email = "first.last@example.com",
           comment = c(ORCID = "YOUR-ORCID-ID"))
Description: Reduces time series
License: What license it uses
Encoding: UTF-8
LazyData: true
Imports:  
    tidyverse,
    lubridate
```


---
title: "How to get R work with Python"
subtitle: "A practical example of how to use R code in Python"
author: "Jens Laufer"
date: "20 9 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message = F, warning = F)
```


R and Python are outstanding languages for data science. While Python is a easy-to-learn general-purpose language R 
is a niche language from the statistics fields. Python's pandas and numpy library  and base R are very similiar for 
data processing. One could say, that there is no need to learn R, however thanks to Hadley Wickham's tidyverse 
libraries with their grammar of graphics (ggplot2) and grammar of data manipulation (dpylr) 
R is superior for data analysis and processing. It's therefore worth to have both languages in your toolset. 

Is it possible to use the language site-by-site? Let's think of a scenario where we use R for 
data preprocessing and Python for training machine learning models. In this article I want to show you 
how to use R functions in our Python code. We want to use [rpy2](https://rpy2.readthedocs.io), which lets us 
call functions in R library like functions in Python code. However there are several pitfalls I want to show you. 
We use Docker in this example to get reprocable environment.




##
We change into a R console

```R
install.packages('devtools')
library('devtools')
devtools::create('reducer')
```

These commands create a basic file structure for our module. The R directory will hold all R files for our library.

```shell
.
├── DESCRIPTION
├── NAMESPACE
└── R
```
NAMESPACE

```R
exportPattern("^[^\\.]")
importFrom("magrittr","%>%")
```

DESCRIPTION
```yaml
Package: reducer
Title: Reduces time series
Version: 0.1.0
Authors@R: 
    person(given = "First",
           family = "Last",
           role = c("aut", "cre"),
           email = "first.last@example.com",
           comment = c(ORCID = "YOUR-ORCID-ID"))
Description: Reduces time series
License: What license it uses
Encoding: UTF-8
LazyData: true
Imports:  
    tidyverse,
    lubridate
```


### Step 2: Github for source code version control and library repository ###

We create a new Git repository for our project on the Github website:

![Project Creation on Github](https://res.cloudinary.com/jenslaufer/image/upload/c_scale,w_888/v1569306497/github_repo_create.png)

```shell
git init
git remote add origin git@github.com:jenslaufer/reducer.git
git push -u origin master
```

Once we pushed our code to Github, we can install the our library with the install.github function from the devtools library. We use a public repository 
in our case which makes live easy, however you can install as well install libraries from private repositories.

```R
install.github('jenslaufer/sample-r-library-reducer')
```

- Github repository install of Python library
- Pitfalls:
   - magrittr pipe %>%
   - no library and require statements in library code
   - full name with imported libs mutate -> dplyr::mutate
   - private function exclusion


## Step 3: Call the R function like it would be a python function ##




## Step 1: We live in a container ##

To have a reliable reproducable runtime environment it's a good idea to run your application unto [Docker](https://docker.com). 
You can download it from the website for the most important  operating systems.

Docker is software is software tool to create lightweight containers with everything needed to run an application. 
You increase the reproducability and protability of you application by doing this. Our requirement is a container with two programming languages and some
preinstalled libraries. Get this setup working reliable in a production environment without Docker could be difficult.

In our case we need a container with R, Python, our preinstalled libary and rpy2. 

- Docker container with R and Python installed


```Dockerfile
FROM python:3.7-slim-buster

RUN apt-get update && apt-get install -y r-base

RUN R -e "install.packages(c('tidyverse', 'lubridate', 'devtools'), repos = 'http://cran.us.r-project.org')"
RUN R -e "install.github('jenslaufer/sample-r-library-reducer')"

RUN pip install rpy2
```

We use a base container with pre installed Python 3.7. On top we are installing base R, afterwards are are installing serveral important libarires in the contain
Our libray is installed with the install.github the command we talked about before. Last not but least we are installing the rpy2 module with pip for python.

We can build the container, however I have done this for you. So we can use the conatiner just now

```shell
docker exec -it jenslaufer/reducer:latest bash
```

What does this line do? It downloads our already-built computer to your machine and opens a bash in the container. So we can easily execute our Python example code now, 
everything what we need for excution is packed in the container.





