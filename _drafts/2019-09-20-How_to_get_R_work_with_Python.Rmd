---
title: "How to get R work with Python"
subtitle: "5 Steps to use a R library from Python with rpy2"
author: "Jens Laufer"
date: "20 9 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message = F, warning = F)
```

R and Python are outstanding languages for data science. While Python is a easy-to-learn general-purpose language R
is a niche language from the statistics fields. Python's pandas and numpy library  and base R are very similiar for
data processing. One could say, that there is no need to learn R, however thanks to Hadley Wickham's tidyverse
libraries with their grammar of graphics (ggplot2) and grammar of data manipulation (dpylr)
R is superior for data analysis and processing. It's therefore worth to have both languages in your toolset.

Is it possible to use the language site-by-site? Let's think of a scenario where we use R for 
data preprocessing and Python for training machine learning models. In this article I want to show you 
how to use R functions in our Python code. We want to use [rpy2](https://rpy2.readthedocs.io), which lets us 
call functions in R library like functions in Python code. However there are several pitfalls I want to show you. 
We use Docker in this example to get reproducable environment.

## Step 1- Create the skeleton for the R library

We change into a R console and execute the following commands:

```R
install.packages('devtools')
library('devtools')
devtools::create('reducer')
```

These commands create a basic file structure for our module. The R directory will hold all R files for our library.

```shell
.
├── DESCRIPTION
├── NAMESPACE
└── R
```

The NAMESPACE

```R
exportPattern("^[^\\.]")
importFrom("magrittr","%>%")
```

The DESCRIPTION file is to describe your librry with some meta data about the library like version, 
ownership, description, license and dependent libraries needed for our libraries

```yaml
Package: reducer
Title: Reduces time series
Version: 0.1.0
Authors@R: 
    person(given = "First",
           family = "Last",
           role = c("aut", "cre"),
           email = "first.last@example.com",
           comment = c(ORCID = "YOUR-ORCID-ID"))
Description: Reduces time series
License: What license it uses
Encoding: UTF-8
LazyData: true
Imports:  
    tidyverse
```

We switch into the R folder and create a R script called with some dummy code to test our first iteration:

```R
.get.super.unit <- function(unit) {
  switch(
    unit,
    "second" = "minute",
    "minute" = "hour",
    "hour" = "day",
    "day" = "month",
    "month" = "year"
  )
}

reduce <- function(df, time.interval, unit, date_field) {
  super.unit <- .get.super.unit(unit)
  unit.pl <- "lubridate::{unit}s" %>% glue::glue()
  unit <- "lubridate::{unit}" %>% glue::glue()
  
  df %>%
    dplyr::mutate(
      interval = lubridate::floor_date(!!as.name(date_field), unit = super.unit) + eval(parse(text = unit.pl))(ceiling(
        eval(parse(text = unit))(!!as.name(date_field)) / time.interval
      ) * time.interval)
    ) %>%
    dplyr::group_by(interval) %>%
    dplyr::summarise_all(~ mean(.)) %>%
    dplyr::ungroup() %>%
    dplyr::select(-date) %>%
    dplyr::rename(date = interval)
}
```


## Step 2- Use GitHub for version controlling and as R library repository


We create a new Git repository for our project on the Github website:

![Project Creation on Github](https://res.cloudinary.com/jenslaufer/image/upload/c_scale,w_888/v1569306497/github_repo_create.png)

```shell
git init
git add .
git commit -m "initial"
git remote add origin git@github.com:jenslaufer/sample-r-library-reducer.git
git push -u origin master
```

Once we pushed our code to Github, we can install our library with the install.github function with the devtools library in R. 
We use a public repository  in our case which makes live easy, however you can install as well install libraries from private repositories.
In case you have R already installed you can install and use our library now. Don't mind if you don't have R. We will use Docker in 
this example, so there is no need to install it.

```R
install.github('jenslaufer/sample-r-library-reducer')
library(reducer)
reducer::reduce()
```

This should print "reducing." to the screen.

## Step 3- Write Python code to call function R library

We create the code to call the first simple implementation of our r rlibrary and put into a file named test.py:

```python
import rpy2.robjects.packages as rpackages

reducer = rpackages.importr('reducer')

reducer.reduce()
```

## Step 4- Get everything run up and running Docker

To have a reliable reproducable runtime environment it's a good idea to run your application unto [Docker](https://docker.com). 
You can download it from the website for the most important  operating systems.

Docker is software is software tool to create lightweight containers with everything needed to run an application. 
You increase the reproducability and protability of you application by doing this. Our requirement is a container with two programming languages and some
preinstalled libraries. Get this setup working reliable in a production environment without Docker could be difficult.

In our case we need a container with R, Python, our preinstalled libary and rpy2. This setup s

- Docker container with R and Python installed

```Dockerfile
FROM python:3.7-slim-buster

RUN apt-get update && apt-get install -y r-base

RUN R -e "install.packages(c('tidyverse', 'devtools'), repos = 'http://cran.us.r-project.org')"
RUN R -e "install.github('jenslaufer/sample-r-library-reducer')"

RUN pip install rpy2
```

We use a base container with pre installed Python 3.7. On top we are installing base R, afterwards are are installing serveral important libarires in the contain
Our libray is installed with the install.github the command we talked about before. Last not but least we are installing the rpy2 module with pip for python.

We can build the container, however I have done this for you. So we can use the conatiner just now

```shell
docker exec -it jenslaufer/reducer:latest bash
```

What does this line do? It downloads our already-built computer to your machine and opens a bash in the container. So we can easily execute our Python example code now, 
everything what we need for excution is packed in the container.


## Step 5- Implement the R function and the python call
